# Service Description

## Background
Our customers are sending billions of requests each day that need to be
processed. Today, all incoming requests are processed regardless of
their validity, leading to slower processing. We want to filter out
invalid requests (badly formatted, containing invalid values, missing
required fields, â€¦) but keep a history on a day-by-day basis so that
we can properly charge customers for the traffic they send.

## Service Abilities
It is a REST-service that:
- receives requests generated by our collector
- check the validity of each request
- reject invalid requests
- count and store statistics per customer per hour
For now the code contains a stub function with valid request. It would be fulfilled in the next iteration of the service.

The service also provides an endpoint to get the *statistics* for:
- specific customer 
- a specific day
The response contains the total number of requests for specified day.

### Requests considered as invalid are:
* malformed JSON
* missing one or more fields
* with a customer ID not found in the database or for a customer which is disabled
* with a remote IP address which is in the blacklist
* with a user agent which is in the blacklist

### The stats table contains:
* one entry per hour and per customer ID
* the `request_count` column contains the number of valid requests
* the `invalid_count` column will be used for the number of invalid requests

## Setup

### Prerequisites 

Installed Docker is required

### Start Service

You can run both Postgres and Request Processing service in Dockers..

`docker compose up`

..or only Postgres and play with the local run in your IDE (no need to set any env variables)

`docker compose up database `

## Testing

After dockers are running service is ready for your requests.

### API check
Swagger API documentation is available with on:
http://localhost:8080/swagger-ui/index.html

Note that due to manual parsing and validation input requests for /request endpoint, there is no strict schema for input parameter.
Take this model as a reference:
```json
{"customerID":1,"tagID":2,"userID":"aaaaaaaa-bbbb-cccc-1111-222222222222","remoteIP":"123.234.56.78","timestamp":1500000000}
```

### Test request
You can use Postman for testing. 

Request examples:

To check invalid JSON
```
POST http://localhost:8080/api/v1/request

{ 
    "not": "all",
    "properties": 
```

To check wrong data model
```
POST http://localhost:8080/api/v1/request

{ 
    "not": "all",
    "properties": 1
}
```

Sending valid request:
```
POST http://localhost:8080/api/v1/request

{"customerID":1,"tagID":2,"userID":"aaaaaaaa-bbbb-cccc-1111-222222222222","remoteIP":"123.234.56.78","timestamp":1702879147417}
```

Getting statistics for customer:
```
POST http://localhost:8080/api/v1/statistics

{"customerID":1,"date": "2023-12-18"}

```